# Caddyfile for S3 Reverse Proxy with SPA Support

# Global options block.
{
    debug 
}

# Define the HTTP server
http://:{$SERVER_PORT:-8080} {
    log {
        output stderr
        level  DEBUG
    }

    # Health check endpoint
    handle /healthz {
        respond "OK" 200
    }

    # Handle errors, specifically for SPA routing.
    handle_errors {
        @spa_fallback expression {http.error.status_code} == 403 || {http.error.status_code} == 404

        handle @spa_fallback {
            # Construct the full path to the SPA entrypoint in the bucket.
            # e.g., /frontend-assets/index.html
            rewrite * {$BUCKET_PATH_PREFIX}{$SPA_ENTRYPOINT_PATH:-/index.html}
            
            # Proxy to the Minio base URL. Caddy will use the rewritten path.
            reverse_proxy {$MINIO_UPSTREAM_URL} {
                header_up Host {http.reverse_proxy.upstream.hostport}
            }
        }

        respond "{http.error.status_code} {http.error.status_text}" {
            close
        }
    }

    # Main reverse proxy handler.
    handle {
        # Prepend the bucket path prefix to the original request path.
        # e.g., if request is /css/style.css, URI becomes /frontend-assets/css/style.css
        rewrite * {$BUCKET_PATH_PREFIX}{http.request.uri.path}

        # Proxy to the Minio base URL. Caddy will use the rewritten path.
        reverse_proxy {$MINIO_UPSTREAM_URL} {
            header_up Host {http.reverse_proxy.upstream.hostport}
        }
    }
}